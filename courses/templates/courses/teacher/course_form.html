{% extends "base.html" %}
{% block content %}
<style>
    .alo-container { max-width: 100%; overflow-x: hidden; }
    .alo-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: nowrap; width: 100%; }
    .alo-select { flex: 1; min-width: 0; }
    .alo-select select { width: 100%; font-size: 0.85rem; }
    .alo-input { width: 75px; flex-shrink: 0; }
    .card-assessment { border-left: 6px solid #dc3545; }
</style>

<div class="container py-4">
    {% if messages %}{% for message in messages %}<div class="alert alert-{{ message.tags }}">{{ message }}</div>{% endfor %}{% endif %}
    <h2 class="mb-4">{% if is_create %}Create Course{% else %}Edit Course{% endif %}</h2>
    <form method="post" id="course-form">
        {% csrf_token %}{{ form.instructor }}
        <div class="card mb-4 border-primary shadow-sm">
            <div class="card-header bg-primary text-white fw-bold">1. Course Information</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3"><label class="small fw-bold">Code</label>{{ form.code }}</div>
                    <div class="col-md-7"><label class="small fw-bold">Title</label>{{ form.title }}</div>
                    <div class="col-md-2"><label class="small fw-bold">ECTS</label>{{ form.ects_credit }}</div>
                </div>
            </div>
        </div>
        <div class="card mb-4 border-info shadow-sm">
            <div class="card-header bg-info text-white fw-bold">2. Learning Outcomes (LO)</div>
            <div class="card-body p-0">
                {{ lo_formset.management_form }}
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light"><tr><th class="ps-3">LO Title</th><th class="text-center" style="width: 80px;">Del</th></tr></thead>
                    <tbody id="lo-tbody">
                        {% for f in lo_formset %}<tr><td class="ps-3">{{ f.id }}{{ f.title }}</td><td class="text-center">{{ f.DELETE }}</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">3. Assessments & Synergy Mapping</h5>
                <button type="button" class="btn btn-dark btn-sm" id="add-assessment">+ Add Assessment</button>
            </div>
            {{ formset.management_form }}{{ formset.non_field_errors }}
            <div id="assessment-list">
                {% for row in assessment_rows %}
                <div class="card mb-4 card-assessment shadow-sm assessment-form-row">
                    <div class="card-body bg-light">
                        <div class="row g-2 align-items-center border-bottom pb-2 mb-3">
                            {{ row.form.id }}
                            <div class="col-md-5"><label class="small fw-bold">Type</label>{{ row.form.type }}</div>
                            <div class="col-md-4"><label class="small fw-bold">Weight (%)</label>{{ row.form.weight_percentage }}</div>
                            <div class="col-md-3 text-end pt-3">
                                <span class="badge bg-danger p-2">{{ row.form.DELETE }} Delete Assessment</span>
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-white rounded border alo-container shadow-sm">
                            <div class="d-flex justify-content-between border-bottom pb-2 mb-3">
                                <h6 class="small fw-bold text-muted mb-0">LO Contributions (Optional):</h6>
                                <button type="button" class="btn btn-link btn-sm p-0 add-alo-btn text-decoration-none">+ Add LO</button>
                            </div>
                            {{ row.alo_fs.management_form }}
                            <div class="alo-list">
                                {% for sub in row.alo_fs %}
                                <div class="alo-row">
                                    {{ sub.id }}{{ sub.learning_outcome }}
                                    <div class="alo-input">{{ sub.contribution_percentage }}</div>
                                    <span class="small fw-bold">%</span>
                                    {% if sub.instance.pk %}<div class="small text-danger ms-1">{{ sub.DELETE }}</div>{% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <button type="submit" class="btn btn-success btn-lg w-100 shadow fw-bold py-3">SAVE</button>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const assessmentList = document.getElementById('assessment-list');
    const addAssessmentBtn = document.getElementById('add-assessment');
    const assessmentTotalForms = document.getElementById('id_assessments-TOTAL_FORMS');
    addAssessmentBtn.addEventListener('click', function() {
        const count = parseInt(assessmentTotalForms.value);
        const firstCard = assessmentList.querySelector('.assessment-form-row');
        const newCard = firstCard.cloneNode(true);
        newCard.innerHTML = newCard.innerHTML.replace(/assessments-\d+/g, `assessments-${count}`);
        newCard.innerHTML = newCard.innerHTML.replace(/assessmentlearningoutcome-\d+/g, `assessmentlearningoutcome-${count}`);
        newCard.querySelectorAll('input, select').forEach(el => { 
            if(el.type !== 'hidden' && !el.classList.contains('form-check-input')) el.value = ''; 
            if(el.type === 'hidden' && el.name.includes('id')) el.value = '';
        });
        newCard.querySelector('input[name$="-TOTAL_FORMS"]').value = 1;
        newCard.querySelector('input[name$="-INITIAL_FORMS"]').value = 0;
        assessmentList.appendChild(newCard);
        assessmentTotalForms.value = count + 1;
    });
    assessmentList.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-alo-btn')) {
            const card = e.target.closest('.assessment-form-row');
            const aloList = card.querySelector('.alo-list');
            const totalForms = card.querySelector('input[name$="-TOTAL_FORMS"]');
            const count = parseInt(totalForms.value);
            const firstRow = aloList.querySelector('.alo-row');
            const newRow = firstRow.cloneNode(true);
            const regex = new RegExp(`assessmentlearningoutcome-\\d+-(\\d+)`, 'g');
            newRow.innerHTML = newRow.innerHTML.replace(regex, (match, p1) => match.replace(`-${p1}`, `-${count}`));
            newRow.querySelectorAll('input, select').forEach(el => { if(!el.name.includes('DELETE')) el.value = ''; });
            aloList.appendChild(newRow);
            totalForms.value = count + 1;
        }
    });
});
</script>
{% endblock %}